# Phase 4 Implementation Plan: Trendyol Marketplace Integration

## Goal Description
Connect MyTienda to Trendyol's API using a secure, asynchronous architecture. API keys will be stored AES-256 encrypted. Product sync will run via a BullMQ queue to prevent server timeouts. All API endpoint URLs will be taken exclusively from `backend/docs/trendyol_endpoints.json`.

## ðŸš¨ Mandatory Red-Line Rules

> [!CAUTION]
> **AES-256:** Trendyol `api_key` and `api_secret` must NEVER be stored as plain text. They will be encrypted with AES-256 before writing to `public.integrations.api_credentials` and decrypted only at runtime.

> [!CAUTION]
> **BullMQ Queue:** Product sync must be triggered via a BullMQ job, NOT by a direct API call chain. Endpoint returns a `202 Accepted` immediately; the worker runs in the background with pagination (`?size=100&pageKey=...`).

> [!CAUTION]
> **Strict Endpoint Reference:** ALL Trendyol API URLs must be sourced directly from `backend/docs/trendyol_endpoints.json`. No agent may invent, guess, or use a previously known URL.

---

## Proposed Changes

### Backend Agent

#### [NEW] [encryption.js](file:///Users/berke/Desktop/Projects/MyTienda/backend/src/utils/encryption.js)
- `encrypt(text)` â†’ AES-256-CBC with IV, returns `iv:ciphertext` hex string
- `decrypt(payload)` â†’ Reverses the above
- Key sourced from `process.env.ENCRYPTION_SECRET`

---

#### [NEW] [TrendyolService.js](file:///Users/berke/Desktop/Projects/MyTienda/backend/src/services/TrendyolService.js)
- Constructor: accepts `{ sellerId, apiKey, apiSecret }`
- Builds Basic Auth header: `base64(apiKey:apiSecret)`
- Methods:
  - `getProducts(pageKey)` â†’ `GET /integration/ecgw/v2/{sellerId}/products?size=100&pageKey={pageKey}`
  - `getOrders(status)` â†’ `GET /integration/order/sellers/{sellerId}/orders`
  - `cancelOrder(packageId, reasonCode)` â†’ `PUT /integration/order/sellers/{sellerId}/shipment-packages/{packageId}/unsupplied`
  - `splitOrder(packageId, body)` â†’ `POST /integration/order/sellers/{sellerId}/shipment-packages/{packageId}/split`
  - `getQuestions()` â†’ `GET /integration/qna/sellers/{sellerId}/questions/filter?status=WAITING_FOR_ANSWER`
  - `answerQuestion(questionId, answer)` â†’ `POST /integration/qna/sellers/{sellerId}/questions/{id}/answers`
  - `getAddresses()` â†’ `GET /integration/sellers/{sellerId}/addresses` *(used for connection test)*

#### [NEW] [TrendyolAdapter.js](file:///Users/berke/Desktop/Projects/MyTienda/backend/src/services/adapters/TrendyolAdapter.js)
- `toProduct(trendyolItem)` â†’ maps to `{ name, brand, attributes }`
- `toVariant(trendyolItem)` â†’ maps to `{ sku, barcode, price, compare_at_price }`
- `toListing(trendyolItem, variantId, integrationId)` â†’ maps to `{ remote_product_id, remote_sku, sync_status }`

#### [NEW] [productSyncQueue.js](file:///Users/berke/Desktop/Projects/MyTienda/backend/src/queues/productSyncQueue.js)
- BullMQ `Queue` named `product-sync` backed by `process.env.REDIS_URL`
- Worker: loops `getProducts(pageKey)` while `hasNextPage`, upserts `products`, `variants`, `product_listings` per the barcode-based mapping rule

#### [NEW] [integration.routes.js](file:///Users/berke/Desktop/Projects/MyTienda/backend/src/routes/integration.routes.js)
- `POST /api/integrations/trendyol/connect` â€” Decrypt â†’ test (getAddresses) â†’ encrypt â†’ save to DB
- `POST /api/integrations/trendyol/sync-products` â€” Add BullMQ job â†’ `202 Accepted`

#### [NEW] [orders.routes.js](file:///Users/berke/Desktop/Projects/MyTienda/backend/src/routes/orders.routes.js)
- `GET /api/orders`
- `PUT /api/orders/:id/unsupplied` (reason codes: 500, 501, 502, 504, 505, 506)
- `POST /api/orders/:id/split`

#### [NEW] [qna.routes.js](file:///Users/berke/Desktop/Projects/MyTienda/backend/src/routes/qna.routes.js)
- `GET /api/qna`
- `POST /api/qna/:id/answer`

#### [MODIFY] [index.js](file:///Users/berke/Desktop/Projects/MyTienda/backend/src/index.js)
- Mount 3 new route files under `/api`

---

### Frontend Agent

#### [NEW] `/settings/integrations` page
- Trendyol API Key, Secret, Seller ID form
- On save: calls `POST /api/integrations/trendyol/connect`
- Shows "BaÄŸlandÄ± âœ“" badge on success

#### [NEW] `/products` page
- Shadcn/UI DataTable: Image | Name | Barcode | Stock | Price | Marketplace Status badge
- "Pazaryerinden EÅŸitle" button â†’ calls `POST /api/integrations/trendyol/sync-products`

#### [NEW] `/orders` page
- Order list with status badges
- "Tedarik Edilemedi" modal: dropdown with Trendyol cancel reason codes (500â†’506)
- "Paketi BÃ¶l" button

#### [NEW] `/crm/questions` page
- Split layout: question list (left) + chat window (right)
- Text input + send button â†’ calls `POST /api/qna/:id/answer`

---

## Verification Plan

### Automated Tests
- `tests/encryption.test.js` â€” encrypt/decrypt round-trip
- `tests/integration.test.js` â€” mock Trendyol API, test connect + sync-products endpoints

### Manual Verification
- Save Trendyol credentials â†’ check `integrations.api_credentials` in Supabase is unreadable ciphertext
- Trigger product sync â†’ verify BullMQ job created and products appear in DB
- Cancel an order â†’ verify correct reason code sent to Trendyol API URL from `trendyol_endpoints.json`
